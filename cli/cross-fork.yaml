#!/usr/bin/env signadot sandbox apply -f
# sandbox specification for cross fork references.
#
# The frontend service is provided with the forked backend service address 
# via a dynamic environmental variable.
#
# usage:
# signadot sandbox apply -f <this-file>

name: "@{dev}-@{team}-x-@{commit}"    # name of the sandbox
spec:  
  cluster: staging                            # cluster in which this sandbox is to reside.
  description: "@{dev}'s work on feature-x"   # a short description
  forks:                                      # set of workloads to fork and how to fork.
  - forkOf:                                   # what to fork
      kind: Deployment                        # K8s Kind of workload to fork (Deployment or ArgoRollout).
      name: frontend                          # K8s name of workload to fork.
      namespace: "@{namespace}"               # K8s namespace in which the workload to fork resides.
    customizations:                           # how to fork the workload specified by forkOf
      env:                                    # define environment for containers in fork.
      - name: BACKEND_ADDR
        valueFrom:                            # dynamic value, determined when the fork is created.
          fork:                               # from a fork.
            forkOf:                           # defines which fork (must exist in this sandbox).
              kind: Deployment                # K8s kind (Deployment or ArgoRollout).
              namespace: "@{namespace}"       # K8s namespace.
              name: backend                   # K8s name
            expression: "{{.Service.Host}}:{{.Service.Port}}"  # fork-creation-time expanded expression.
    endpoints:
    - port: 8080
      name: frontend
      protocol: http
  - forkOf:                                   # multiple forks are possible.
      kind: Deployment
      name: backend
      namespace: "@{namespace}"
